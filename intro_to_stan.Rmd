---
title: "Introduction to STAN"
subtitle: "A probabilistic programming language"
author: Songpeng Zu
date: "`r format(Sys.time(), '%d %B %Y')`"
bibliography: ref.bib
urlcolor: blue
fontsize: 10pt
output:
  # pdf_document:
    # keep_tex: true
  beamer_presentation:
    # theme: "CambridgeUS"
    colortheme: "beaver"
    fonttheme: "professionalfonts"
    keep_tex: true
    # incremental: true
    fig_width: 7
    fig_height: 6
    fig_caption: true
    df_print: kable
    highlight: tango
    citation_package: natbib
    latex_engine: xelatex
    template: "pandoc/mydefault.latex"
    slide_level: 3
    includes:
      in_header: "pandoc/preamble.tex"
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "")
```

### What is STAN [^1]
[^1]: https://mc-stan.org

* A _programming language_
   + the syntax much like C++
   + it's written in C++
   + it's needed to compile and run

* Specifically designed for the _statistical modeling_
   + Vector, matrix, array and their operations
   + A series of probabilistic functions
   + A series of blocks to describe a statistical model.
   + Support sampling, maximum likelihood estimation and variational inference. 

### How STAN works?

* _Hamilton Monte Carlo (HMC)_ provides a general sampling procedure for Bayesian inference

  > _Gradient_ of the log probabilistic density function over the random variables are needed.
  
<!-- * _Viariational Inference (VI)_ and _Maximum likelihood Estimation (MLE)_ -->
  <!-- depend on both the __gradients__ and __optimizer__.  -->
  
* STAN owns a mathematical library [See @carpenter2015stan] that can automatically get the gradients.

* Furthermore, any bounded parameters will be transformed into a non-bounded
  parameter space.
  
### How to use STAN?

* Firstly, we need to write the STAN script ended with .stan to describe the
  data we have, the parameters, and the joint distribution of the parameters and
  the data.

* Secondly, we need to compile and run the codes, and analyze the results.

### Show me an example
Let's consider a simple example. 

* Suppose we have $N$ binary observations $y_{1},
y_{2}, \ldots, y_{N}$. They are the _i.i.d_ samples from a $Bernoulli$
distribution under the parameter $\theta$. 

* Our goal is to infer $\theta$.

### Set up the STAN env in R.
```{r include = TRUE, warning = FALSE, message = FALSE}
library(cmdstanr)
# Note: the cmdstan home path is from my computer.
set_cmdstan_path(path = paste(Sys.getenv("HOME"),
                 "softwares",
                 "cmdstan-2.23.0", sep = "/"))
library(bayesplot)
library(posterior)

cmdstan_path()
cmdstan_version()
```
### STAN script

```{r include = TRUE, warning = FALSE, message = FALSE, cache = TRUE}
bern_mod <- cmdstan_model("bernoulli.stan",
                          ## STAN need to be complied.
                          compile = TRUE)
## show the content in the stan script.
bern_mod$print()
```

### Let's feed it some data {.allowframebreaks}

```{r include = TRUE, results = 'hide'}
bern_data  <- list(N = 10, y = c(0,1,0,0,0,0,0,0,0,1))
## Run MCMC using the 'sample' method
bern_mcmc <- bern_mod$sample(data = bern_data,
                             seed = 355113,
                             chains = 4,
                             parallel_chains = 2,
                             show_message = FALSE)
```

### Summary of the sampling in STAN

```{r include=TRUE}
## use `posterior` package
bern_mcmc$summary("theta", "mean", "sd" , "rhat",
                  "ess_bulk")
```
### Posterior draws {.allowframebreaks}

```{r include=TRUE, collapse = TRUE}
draws <- bern_mcmc$draws()
str(draws)
## use posterior::as_draws_df to transorm the results
## into data.frame.
```

### How about variational inference?

```{r include = TRUE, results = 'hide'}
bern_vb <- bern_mod$variational(data = bern_data,
                                  seed = 355113,
                                  output_samples = 4000)
```

### How about MLE estimation?

```{r include = TRUE, results = 'hide'}
bern_mle <- bern_mod$optimize(data = bern_data,
                              seed = 355113)

```

### Result Summary

```{r echo = TRUE, results = 'hide', fig.height = 3, warning = FALSE, message = FALSE}
bayesplot_grid(
  mcmc_hist(bern_mcmc$draws("theta"), binwidth = 0.02) +
  vline_at(bern_mle$mle(), size = 1.2),
  mcmc_hist(bern_vb$draws("theta"), binwidth = 0.02) +
  vline_at(bern_mle$mle(), size = 1.2),
  titles = c("MCMC", "VI"),
  xlim = c(0,1))
```

### STAN Materials

* [STAN Functions](https://mc-stan.org/docs/2_24/functions-reference/)
  - Use this as the reference materials. When you want some functions, just search it.
  
* [The STAN Language Sytanx](https://mc-stan.org/docs/2_24/reference-manual/index.html)
  - You can scan this if you want to know the whole picture of STAN syntax.
  
* [The User Guide](https://mc-stan.org/docs/2_24/stan-users-guide/index.html)
  - After the introduction, you could read this document smoothly.
  - Lots of examples cover different statistical modelings.
  - It could be a good material to learn statistical models.

### Thanks! 

* You can find this presentation at https://github.com/beyondpie/intro_to_stan.

* Any suggesions or Pull Requests are welcome.
